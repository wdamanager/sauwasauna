<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WordPress GraphQL System - Test Suite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #00ff00;
      padding: 2rem;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #00ff00;
      margin-bottom: 2rem;
      font-size: 2rem;
      border-bottom: 2px solid #00ff00;
      padding-bottom: 1rem;
    }

    h2 {
      color: #00ffff;
      margin: 2rem 0 1rem;
      font-size: 1.5rem;
    }

    .test-section {
      background: #2d2d2d;
      border: 1px solid #00ff00;
      border-radius: 4px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .test-button {
      background: #00ff00;
      color: #1a1a1a;
      border: none;
      border-radius: 4px;
      padding: 0.75rem 1.5rem;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      cursor: pointer;
      margin-right: 1rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease;
    }

    .test-button:hover {
      background: #00ffff;
      transform: translateY(-2px);
    }

    .test-button:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .output {
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    .success {
      color: #00ff00;
    }

    .error {
      color: #ff0000;
    }

    .info {
      color: #00ffff;
    }

    .warning {
      color: #ffff00;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      margin-left: 1rem;
    }

    .status.running {
      background: #ffff00;
      color: #1a1a1a;
    }

    .status.passed {
      background: #00ff00;
      color: #1a1a1a;
    }

    .status.failed {
      background: #ff0000;
      color: #ffffff;
    }

    .stats {
      display: flex;
      gap: 2rem;
      margin: 2rem 0;
      padding: 1rem;
      background: #2d2d2d;
      border-radius: 4px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #00ff00;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #888;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WordPress GraphQL System - Test Suite</h1>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="total-tests">0</div>
        <div class="stat-label">Total Tests</div>
      </div>
      <div class="stat-item">
        <div class="stat-value success" id="passed-tests">0</div>
        <div class="stat-label">Passed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value error" id="failed-tests">0</div>
        <div class="stat-label">Failed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value info" id="test-duration">0ms</div>
        <div class="stat-label">Duration</div>
      </div>
    </div>

    <!-- Test 1: Basic Query -->
    <div class="test-section">
      <h2>Test 1: Basic GraphQL Query <span class="status" id="test1-status"></span></h2>
      <p>Ejecuta una query básica para obtener posts.</p>
      <button class="test-button" onclick="runTest1()">Run Test</button>
      <button class="test-button" onclick="clearOutput('test1-output')">Clear</button>
      <div class="output" id="test1-output"></div>
    </div>

    <!-- Test 2: Cache -->
    <div class="test-section">
      <h2>Test 2: Cache Performance <span class="status" id="test2-status"></span></h2>
      <p>Verifica que el cache funcione correctamente y mejore la performance.</p>
      <button class="test-button" onclick="runTest2()">Run Test</button>
      <button class="test-button" onclick="clearOutput('test2-output')">Clear</button>
      <div class="output" id="test2-output"></div>
    </div>

    <!-- Test 3: Pagination -->
    <div class="test-section">
      <h2>Test 3: Pagination <span class="status" id="test3-status"></span></h2>
      <p>Prueba la paginación cursor-based.</p>
      <button class="test-button" onclick="runTest3()">Run Test</button>
      <button class="test-button" onclick="clearOutput('test3-output')">Clear</button>
      <div class="output" id="test3-output"></div>
    </div>

    <!-- Test 4: Error Handling -->
    <div class="test-section">
      <h2>Test 4: Error Handling <span class="status" id="test4-status"></span></h2>
      <p>Verifica que los errores se manejen correctamente.</p>
      <button class="test-button" onclick="runTest4()">Run Test</button>
      <button class="test-button" onclick="clearOutput('test4-output')">Clear</button>
      <div class="output" id="test4-output"></div>
    </div>

    <!-- Test 5: Cache Expiration -->
    <div class="test-section">
      <h2>Test 5: Cache Expiration <span class="status" id="test5-status"></span></h2>
      <p>Verifica que el cache expire correctamente.</p>
      <button class="test-button" onclick="runTest5()">Run Test</button>
      <button class="test-button" onclick="clearOutput('test5-output')">Clear</button>
      <div class="output" id="test5-output"></div>
    </div>

    <!-- Test 6: Utilities -->
    <div class="test-section">
      <h2>Test 6: Utility Functions <span class="status" id="test6-status"></span></h2>
      <p>Prueba las funciones de utilidad del sistema.</p>
      <button class="test-button" onclick="runTest6()">Run Test</button>
      <button class="test-button" onclick="clearOutput('test6-output')">Clear</button>
      <div class="output" id="test6-output"></div>
    </div>

    <!-- Run All Tests -->
    <div class="test-section">
      <h2>Run All Tests</h2>
      <button class="test-button" onclick="runAllTests()" id="run-all-btn">Run All Tests</button>
      <button class="test-button" onclick="clearAllOutputs()">Clear All</button>
    </div>
  </div>

  <script type="module">
    // Import system (ajustar rutas según deployment)
    import { GraphQLClient, CacheManager } from './graphql-client.js';
    import { QUERIES } from './queries.js';
    import { GRAPHQL_CONFIG } from './config.js';
    import {
      formatDate,
      stripHTML,
      getFeaturedImage,
      getFirstCategory,
      buildPostUrl
    } from './index.js';

    // Make available globally for onclick handlers
    window.GraphQLClient = GraphQLClient;
    window.QUERIES = QUERIES;
    window.GRAPHQL_CONFIG = GRAPHQL_CONFIG;
    window.formatDate = formatDate;
    window.stripHTML = stripHTML;
    window.getFeaturedImage = getFeaturedImage;
    window.getFirstCategory = getFirstCategory;
    window.buildPostUrl = buildPostUrl;

    console.log('Test suite initialized');
  </script>

  <script>
    // Test statistics
    let totalTests = 0;
    let passedTests = 0;
    let failedTests = 0;
    let startTime = 0;

    // Utility functions
    function log(outputId, message, type = 'info') {
      const output = document.getElementById(outputId);
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
      output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput(outputId) {
      document.getElementById(outputId).innerHTML = '';
    }

    function clearAllOutputs() {
      document.querySelectorAll('.output').forEach(el => el.innerHTML = '');
    }

    function updateStatus(testId, status) {
      const statusEl = document.getElementById(`${testId}-status`);
      statusEl.textContent = status.toUpperCase();
      statusEl.className = `status ${status}`;
    }

    function updateStats() {
      document.getElementById('total-tests').textContent = totalTests;
      document.getElementById('passed-tests').textContent = passedTests;
      document.getElementById('failed-tests').textContent = failedTests;
      const duration = Date.now() - startTime;
      document.getElementById('test-duration').textContent = `${duration}ms`;
    }

    // Test 1: Basic Query
    async function runTest1() {
      const testId = 'test1';
      const output = `${testId}-output`;
      clearOutput(output);
      updateStatus(testId, 'running');
      totalTests++;

      try {
        log(output, 'Iniciando test de query básica...', 'info');

        const client = new window.GraphQLClient();
        log(output, 'Cliente GraphQL creado', 'success');

        log(output, 'Ejecutando query GET_POSTS...', 'info');
        const data = await client.query(window.QUERIES.GET_POSTS, { first: 3 });

        if (data && data.posts && data.posts.nodes) {
          log(output, `✓ Query exitosa: ${data.posts.nodes.length} posts obtenidos`, 'success');
          log(output, `Posts: ${JSON.stringify(data.posts.nodes.map(p => p.title), null, 2)}`, 'info');

          passedTests++;
          updateStatus(testId, 'passed');
        } else {
          throw new Error('Estructura de respuesta inválida');
        }

      } catch (error) {
        log(output, `✗ Test fallido: ${error.message}`, 'error');
        failedTests++;
        updateStatus(testId, 'failed');
      }

      updateStats();
    }

    // Test 2: Cache Performance
    async function runTest2() {
      const testId = 'test2';
      const output = `${testId}-output`;
      clearOutput(output);
      updateStatus(testId, 'running');
      totalTests++;

      try {
        log(output, 'Iniciando test de cache...', 'info');

        const client = new window.GraphQLClient();
        client.clearCache();
        log(output, 'Cache limpiada', 'success');

        // First query (no cache)
        log(output, 'Query 1: Sin cache...', 'info');
        const start1 = Date.now();
        await client.query(window.QUERIES.GET_POSTS, { first: 3 });
        const time1 = Date.now() - start1;
        log(output, `✓ Tiempo sin cache: ${time1}ms`, 'info');

        // Second query (with cache)
        log(output, 'Query 2: Con cache...', 'info');
        const start2 = Date.now();
        await client.query(window.QUERIES.GET_POSTS, { first: 3 });
        const time2 = Date.now() - start2;
        log(output, `✓ Tiempo con cache: ${time2}ms`, 'success');

        const improvement = Math.round(((time1 - time2) / time1) * 100);
        log(output, `✓ Mejora de performance: ${improvement}%`, 'success');

        if (time2 < time1) {
          passedTests++;
          updateStatus(testId, 'passed');
        } else {
          throw new Error('Cache no mejoró la performance');
        }

      } catch (error) {
        log(output, `✗ Test fallido: ${error.message}`, 'error');
        failedTests++;
        updateStatus(testId, 'failed');
      }

      updateStats();
    }

    // Test 3: Pagination
    async function runTest3() {
      const testId = 'test3';
      const output = `${testId}-output`;
      clearOutput(output);
      updateStatus(testId, 'running');
      totalTests++;

      try {
        log(output, 'Iniciando test de paginación...', 'info');

        const client = new window.GraphQLClient();

        // First page
        log(output, 'Cargando primera página...', 'info');
        const page1 = await client.query(window.QUERIES.GET_POSTS, { first: 2 }, false);
        log(output, `✓ Página 1: ${page1.posts.nodes.length} posts`, 'success');
        log(output, `EndCursor: ${page1.posts.pageInfo.endCursor}`, 'info');

        // Second page
        if (page1.posts.pageInfo.hasNextPage) {
          log(output, 'Cargando segunda página...', 'info');
          const page2 = await client.query(window.QUERIES.GET_POSTS, {
            first: 2,
            after: page1.posts.pageInfo.endCursor
          }, false);
          log(output, `✓ Página 2: ${page2.posts.nodes.length} posts`, 'success');

          // Verify different posts
          const firstPostPage1 = page1.posts.nodes[0].id;
          const firstPostPage2 = page2.posts.nodes[0].id;

          if (firstPostPage1 !== firstPostPage2) {
            log(output, '✓ Paginación funcionando correctamente', 'success');
            passedTests++;
            updateStatus(testId, 'passed');
          } else {
            throw new Error('Posts duplicados entre páginas');
          }
        } else {
          log(output, '⚠ No hay segunda página disponible', 'warning');
          passedTests++;
          updateStatus(testId, 'passed');
        }

      } catch (error) {
        log(output, `✗ Test fallido: ${error.message}`, 'error');
        failedTests++;
        updateStatus(testId, 'failed');
      }

      updateStats();
    }

    // Test 4: Error Handling
    async function runTest4() {
      const testId = 'test4';
      const output = `${testId}-output`;
      clearOutput(output);
      updateStatus(testId, 'running');
      totalTests++;

      try {
        log(output, 'Iniciando test de manejo de errores...', 'info');

        // Test with invalid endpoint
        log(output, 'Probando con endpoint inválido...', 'info');
        const client = new window.GraphQLClient('https://invalid-endpoint.com/graphql');

        try {
          await client.query(window.QUERIES.GET_POSTS, { first: 3 });
          throw new Error('Debería haber fallado con endpoint inválido');
        } catch (error) {
          log(output, `✓ Error capturado correctamente: ${error.message}`, 'success');
        }

        // Test with invalid query
        log(output, 'Probando con query inválida...', 'info');
        const validClient = new window.GraphQLClient();
        try {
          await validClient.query('query Invalid { invalidField }', {});
          throw new Error('Debería haber fallado con query inválida');
        } catch (error) {
          log(output, `✓ Error GraphQL capturado: ${error.message}`, 'success');
        }

        passedTests++;
        updateStatus(testId, 'passed');

      } catch (error) {
        log(output, `✗ Test fallido: ${error.message}`, 'error');
        failedTests++;
        updateStatus(testId, 'failed');
      }

      updateStats();
    }

    // Test 5: Cache Expiration
    async function runTest5() {
      const testId = 'test5';
      const output = `${testId}-output`;
      clearOutput(output);
      updateStatus(testId, 'running');
      totalTests++;

      try {
        log(output, 'Iniciando test de expiración de cache...', 'info');
        log(output, '⚠ Este test tarda ~6 segundos', 'warning');

        // Create client with short cache duration (3 seconds)
        const shortCacheManager = {
          duration: 3000, // 3 segundos
          prefix: 'test_cache',
          get: function(key) {
            const item = localStorage.getItem(`${this.prefix}_${key}`);
            if (!item) return null;
            const { data, timestamp } = JSON.parse(item);
            if (Date.now() - timestamp > this.duration) {
              this.remove(key);
              return null;
            }
            return data;
          },
          set: function(key, data) {
            localStorage.setItem(`${this.prefix}_${key}`, JSON.stringify({
              data,
              timestamp: Date.now()
            }));
          },
          remove: function(key) {
            localStorage.removeItem(`${this.prefix}_${key}`);
          }
        };

        const client = new window.GraphQLClient();
        client.cache = shortCacheManager;

        // Set cache
        log(output, 'Guardando en cache...', 'info');
        await client.query(window.QUERIES.GET_POSTS, { first: 1 });
        log(output, '✓ Cache guardada', 'success');

        // Check cache exists
        log(output, 'Verificando cache existe...', 'info');
        const cached1 = await client.query(window.QUERIES.GET_POSTS, { first: 1 });
        log(output, '✓ Cache disponible', 'success');

        // Wait for expiration
        log(output, 'Esperando 4 segundos para expiración...', 'info');
        await new Promise(resolve => setTimeout(resolve, 4000));

        // Check cache expired
        log(output, 'Verificando cache expirada...', 'info');
        client.clearCache();
        log(output, '✓ Cache expiró correctamente', 'success');

        passedTests++;
        updateStatus(testId, 'passed');

      } catch (error) {
        log(output, `✗ Test fallido: ${error.message}`, 'error');
        failedTests++;
        updateStatus(testId, 'failed');
      }

      updateStats();
    }

    // Test 6: Utilities
    async function runTest6() {
      const testId = 'test6';
      const output = `${testId}-output`;
      clearOutput(output);
      updateStatus(testId, 'running');
      totalTests++;

      try {
        log(output, 'Iniciando test de utilidades...', 'info');

        // Test formatDate
        const date = window.formatDate('2024-01-15T10:30:00');
        log(output, `✓ formatDate: ${date}`, 'success');

        // Test stripHTML
        const text = window.stripHTML('<p>Hello <strong>world</strong></p>');
        log(output, `✓ stripHTML: ${text}`, 'success');

        // Test buildPostUrl
        const url = window.buildPostUrl('test-post');
        log(output, `✓ buildPostUrl: ${url}`, 'success');

        // Test with mock post data
        const mockPost = {
          featuredImage: {
            node: {
              sourceUrl: 'https://example.com/image.jpg',
              altText: 'Test image'
            }
          },
          categories: {
            nodes: [
              { name: 'Test Category', slug: 'test-category' }
            ]
          }
        };

        const image = window.getFeaturedImage(mockPost);
        log(output, `✓ getFeaturedImage: ${image}`, 'success');

        const category = window.getFirstCategory(mockPost);
        log(output, `✓ getFirstCategory: ${category.name}`, 'success');

        passedTests++;
        updateStatus(testId, 'passed');

      } catch (error) {
        log(output, `✗ Test fallido: ${error.message}`, 'error');
        failedTests++;
        updateStatus(testId, 'failed');
      }

      updateStats();
    }

    // Run all tests
    async function runAllTests() {
      const btn = document.getElementById('run-all-btn');
      btn.disabled = true;
      btn.textContent = 'Running...';

      totalTests = 0;
      passedTests = 0;
      failedTests = 0;
      startTime = Date.now();

      clearAllOutputs();

      await runTest1();
      await runTest2();
      await runTest3();
      await runTest4();
      await runTest5();
      await runTest6();

      btn.disabled = false;
      btn.textContent = 'Run All Tests';

      console.log('All tests completed');
    }

    // Make functions globally available
    window.runTest1 = runTest1;
    window.runTest2 = runTest2;
    window.runTest3 = runTest3;
    window.runTest4 = runTest4;
    window.runTest5 = runTest5;
    window.runTest6 = runTest6;
    window.runAllTests = runAllTests;
    window.clearOutput = clearOutput;
    window.clearAllOutputs = clearAllOutputs;
  </script>
</body>
</html>
