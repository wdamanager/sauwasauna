---
/**
 * WDA-963: Dynamic Session Detail Page
 * WDA-990: Enhanced with SSG + Client Hydration pattern
 * Route: /[locale]/[partnerSlug]/[sessionSlug]/
 * Example: /es/hotel-coma-bella/jornadas-de-puertas-abiertas-sauwa/
 *
 * SSG content is rendered immediately, then hydrated with fresh data on client
 */
import type { GetStaticPaths } from 'astro';
import Layout from '../../../../layouts/Layout.astro';
import NavbarScroll from '../../../../components/NavbarScroll.astro';
import FooterBlack from '../../../../components/layout/FooterBlack.astro';
import SessionHero from '../../../../components/booking/SessionHero.astro';
import BookingWidget from '../../../../components/booking/BookingWidget.astro';
import CollaboratorsSection from '../../../../components/booking/CollaboratorsSection.astro';
import DynamicContent from '../../../../components/core/DynamicContent.astro';
import SessionSkeleton from '../../../../components/core/skeletons/SessionSkeleton.astro';
import { getAllSessions, type SessionData } from '../../../../lib/sessions-queries';
import { getBookingContent } from '../../../../lib/i18n/booking';
import { getLocalizedSession } from '../../../../lib/i18n/sessions';

type Locale = 'es' | 'ca' | 'en' | 'fr';
const locales: Locale[] = ['es', 'ca', 'en', 'fr'];

export const getStaticPaths: GetStaticPaths = async () => {
  // Define locales inside getStaticPaths to ensure they're accessible
  const pathLocales: Array<'es' | 'ca' | 'en' | 'fr'> = ['es', 'ca', 'en', 'fr'];

  try {
    const sessions = await getAllSessions();

    if (!sessions || sessions.length === 0) {
      console.warn('[WDA-963] No sessions found for getStaticPaths');
      return [];
    }

    const paths: Array<{
      params: { locale: string; partnerSlug: string; sessionSlug: string };
      props: { session: SessionData };
    }> = [];

    for (const session of sessions) {
      if (!session.partner) {
        console.warn(`[WDA-963] Session ${session.slug} has no partner, skipping`);
        continue;
      }

      // Generate paths for all locales
      for (const locale of pathLocales) {
        // Try to find translation for this locale, or use default slug
        const sessionTranslation = session.translations.find(t => t.locale === locale);
        const sessionSlug = sessionTranslation?.slug || session.slug;

        // Partner slug (no translations in current schema)
        const partnerSlug = session.partner.slug;

        paths.push({
          params: {
            locale,
            partnerSlug,
            sessionSlug,
          },
          props: { session },
        });
      }
    }

    console.log(`[WDA-963] Generated ${paths.length} session detail paths`);
    return paths;
  } catch (error) {
    console.error('[WDA-963] Error generating paths:', error);
    return [];
  }
};

const { locale, partnerSlug, sessionSlug } = Astro.params;
const { session } = Astro.props;

if (!session || !session.partner) {
  return Astro.redirect('/404');
}

// Get localized content (fallback for static sections like "About")
const content = getBookingContent(locale as Locale, 'puertasAbiertas');

// Get localized session fields from ACF with Spanish fallback
const localizedSession = getLocalizedSession({
  title: session.title,
  content: session.content,
  sessionDetails: {
    subtitulo: session.subtitle?.es || null,
    tituloCa: session.localizedTitle?.ca || null,
    subtituloCa: session.subtitle?.ca || null,
    sessionDescriptionCa: session.description?.ca || null,
    tituloEn: session.localizedTitle?.en || null,
    sessionSubtitleEn: session.subtitle?.en || null,
    sessionDescriptionEn: session.description?.en || null,
    tituloFr: session.localizedTitle?.fr || null,
    subtituloFr: session.subtitle?.fr || null,
    sessionDescriptionFr: session.description?.fr || null,
  }
}, locale as Locale);

// Session data
const sessionId = session.databaseId;
const sessionTitle = localizedSession.title;
const sessionSubtitle = localizedSession.subtitle;
const sessionDescription = localizedSession.description;
const duration = session.duration;
const capacity = session.capacity;
const price = session.price;

// Partner data
const partner = session.partner ? {
  name: session.partner.title,
  slug: session.partner.slug,
  logo: session.partner.featuredImage?.sourceUrl,
  address: session.partner.address,
  phone: session.partner.phone,
  email: session.partner.email,
  url: session.partner.web,
  active: true,
} : null;

// Featured image
const backgroundImage = session.featuredImage?.sourceUrl || '';

// WDA-990: Generate content hash for change detection
function generateContentHash(data: unknown): string {
  return JSON.stringify(data).split('').reduce((hash, char) => {
    return ((hash << 5) - hash) + char.charCodeAt(0);
  }, 0).toString(36);
}

const initialHash = generateContentHash({
  title: sessionTitle,
  subtitle: sessionSubtitle,
  description: sessionDescription,
  duration,
  capacity,
  price,
  partnerId: partner?.slug,
});

// SEO
const seoTitle = session.seo?.title || `${sessionTitle} | SAUWA SAUNA`;
const seoDescription = session.seo?.metaDesc || content.seoDescription;

// Sponsors (placeholder - will come from API)
const sponsors = [
  {
    name: 'Aneto Natural',
    logo: '/images/sponsors/aneto-patrocinador-sauwa.jpg',
    url: 'https://www.caldoaneto.com/es',
  },
  {
    name: 'Lapelland',
    logo: '/logos/lapelland-black.svg',
    url: 'https://lapelland.com',
  },
];

// Generate hreflang URLs for other locales
const hreflangs = locales.map(loc => {
  const translation = session.translations.find(t => t.locale === loc);
  const slug = translation?.slug || session.slug;
  return {
    locale: loc,
    href: `https://sauwasauna.com/${loc}/${partnerSlug}/${slug}/`,
  };
});
---

<Layout title={seoTitle} description={seoDescription} lang={locale} pageType="booking">
  <Fragment slot="head">
    <!-- hreflang tags for SEO -->
    {hreflangs.map(({ locale: loc, href }) => (
      <link rel="alternate" hreflang={loc} href={href} />
    ))}
    <link rel="alternate" hreflang="x-default" href={hreflangs[0].href} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={seoTitle} />
    <meta property="og:description" content={seoDescription} />
    {backgroundImage && <meta property="og:image" content={backgroundImage} />}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={seoTitle} />
    <meta name="twitter:description" content={seoDescription} />
    {backgroundImage && <meta name="twitter:image" content={backgroundImage} />}
  </Fragment>

  <NavbarScroll locale={locale} />

  <main>
    <!-- WDA-990: DynamicContent wrapper for SSG + Client Hydration -->
    <DynamicContent
      contentType="session"
      slug={session.slug}
      locale={locale as 'es' | 'ca' | 'en' | 'fr'}
      initialHash={initialHash}
      partnerSlug={partnerSlug}
    >
      <SessionSkeleton slot="skeleton" showHero={false} showAbout={true} showBooking={false} showCollaborators={false} />

      <Fragment slot="content">
        <SessionHero
          title={content.hero.title}
          heading={sessionTitle}
          subtitle={sessionSubtitle}
          duration={duration}
          capacity={capacity}
          price={price}
          location={partner?.name}
          partnerSlug={partner?.slug}
          ctaText={content.hero.ctaText}
          ctaHref="#reserva"
          backgroundImage={backgroundImage}
          locale={locale}
          sessionId={sessionId}
        />

        <!-- About Section - Only show if session has description content -->
        {sessionDescription && sessionDescription.trim() !== '' && (
          <section class="section section--bg-white" data-about-section>
            <div class="container container--narrow">
              <header class="section-header section-header--center">
                <h2 class="section-label section-label--primary">{content.about.title}</h2>
                <h3 class="section-title section-title--center" data-dynamic="session-title">{content.about.heading}</h3>
              </header>

              <div class="about-content" data-hydrate="about-content">
                <div class="about-text" data-dynamic="session-description" set:html={sessionDescription} />
              </div>
            </div>
          </section>
        )}

        <!-- Booking Section -->
        <section id="reserva" class="section section--bg-light booking-section">
          <div class="container">
            <header class="section-header section-header--center">
              <h2 class="section-label section-label--primary">{content.booking.sectionTitle}</h2>
              <h3 class="section-title section-title--center">{content.booking.sectionSubtitle}</h3>
            </header>

            <BookingWidget sessionId={sessionId} locale={locale} />
          </div>
        </section>

        <!-- Collaborators Section -->
        <CollaboratorsSection
          partner={partner}
          sponsors={sponsors}
          locale={locale}
        />
      </Fragment>
    </DynamicContent>
  </main>

  <FooterBlack locale={locale} />
</Layout>

<style>
  /* About Section */
  .about-content {
    max-width: 800px;
    margin: 0 auto;
  }

  :global(.about-content .about-text) {
    font-family: var(--font-family-secondary);
    font-weight: var(--font-weight-light);
    font-size: var(--font-scale-md);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-primary);
  }

  /* WordPress content typography */
  :global(.about-content .about-text p) {
    margin-bottom: 1.25rem;
  }

  :global(.about-content .about-text p:last-child) {
    margin-bottom: 0;
  }

  :global(.about-content .about-text ul),
  :global(.about-content .about-text ol) {
    margin: 1rem 0 1.5rem 1.5rem;
    padding: 0;
  }

  :global(.about-content .about-text li) {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  :global(.about-content .about-text strong),
  :global(.about-content .about-text b) {
    font-weight: var(--font-weight-semibold, 600);
  }

  :global(.about-content .about-text em),
  :global(.about-content .about-text i) {
    font-style: italic;
  }

  :global(.about-content .about-text br) {
    display: block;
    content: "";
    margin-top: 0.5rem;
  }

  :global(.about-content .highlights-list) {
    list-style: none;
    padding: 0;
    margin: 2rem 0 0;
    display: grid;
    gap: 1rem;
  }

  :global(.about-content .highlights-item) {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    font-family: var(--font-family-secondary);
    font-size: var(--font-scale-base);
    color: var(--color-text-primary);
    line-height: 1.5;
  }

  :global(.about-content .highlights-icon) {
    flex-shrink: 0;
    color: #DB4529;
    margin-top: 2px;
  }

  /* Booking Section */
  .booking-section {
    padding-top: 4rem;
    padding-bottom: 4rem;
  }

  /* Responsive */
  @media (max-width: 767px) {
    :global(.about-content .about-text) {
      font-size: var(--font-scale-base);
    }

    .booking-section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
  }
</style>
