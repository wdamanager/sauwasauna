---
/**
 * Dynamic Blog Post Page - French (FR) - Hybrid SSG + Client Refresh
 * WDA-562 FIX: Static generation for shared hosting with client-side refresh
 *
 * This page uses a hybrid approach:
 * 1. Static generation at build time (required for shared hosting)
 * 2. Client-side refresh for latest content (uses 5min cache)
 */

import type { GetStaticPaths } from 'astro';
import Layout from '../../../layouts/Layout.astro';
import FooterBlack from '../../../components/layout/FooterBlack.astro';
import BlogPostHero from '../../../components/blog/BlogPostHero.astro';
import BlogPostContent from '../../../components/blog/BlogPostContent.astro';
import { getBlogPosts, getPostBySlug } from '../../../lib/blog-queries';
import type { BlogPost } from '../../../lib/types/blog';

const locale = 'fr';

// REQUIRED FOR SHARED HOSTING - Generate static pages at build time
export const getStaticPaths: GetStaticPaths = async () => {
  try {
    // Fetch all posts to generate static pages
    const response = await getBlogPosts({
      first: 100,
      language: 'FR'
    });
    const posts = response.posts.nodes;

    if (!posts || posts.length === 0) {
      console.warn('[FR Blog Post] No posts found for static generation');
      return [];
    }

    // Generate paths for each post with initial data
    const paths = await Promise.all(
      posts.map(async (post: BlogPost) => {
        try {
          const fullPost = await getPostBySlug(post.slug);
          if (!fullPost) {
            console.warn(`[FR Blog Post] Could not fetch full content for: ${post.slug}`);
            return null;
          }
          return {
            params: { slug: post.slug },
            props: {
              initialPost: fullPost,
              locale: 'fr'
            },
          };
        } catch (error) {
          console.error(`[FR Blog Post] Error fetching post ${post.slug}:`, error);
          return null;
        }
      })
    );

    return paths.filter((path) => path !== null);
  } catch (error) {
    console.error('[FR Blog Post] Error in getStaticPaths:', error);
    return [];
  }
};

const { slug } = Astro.params;
const { initialPost } = Astro.props;

// Handle 404 case
if (!initialPost) {
  return Astro.redirect('/404');
}

// SEO metadata from initial post
const pageTitle = initialPost.seo?.title || `${initialPost.title} | Blog SAUWA`;
const pageDescription = initialPost.seo?.metaDesc || initialPost.excerpt;
const featuredImageUrl = initialPost.featuredImage?.node?.sourceUrl || '';

// Schema.org structured data
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: initialPost.title,
  datePublished: initialPost.date,
  dateModified: initialPost.modified || initialPost.date,
  author: {
    '@type': 'Person',
    name: initialPost.author?.node?.name || 'SAUWA',
  },
  image: featuredImageUrl,
  publisher: {
    '@type': 'Organization',
    name: 'SAUWA',
    logo: {
      '@type': 'ImageObject',
      url: 'https://sauwasauna.com/images/logo.png',
    },
  },
  description: pageDescription,
};
---

<Layout
  title={pageTitle}
  description={pageDescription}
  lang={locale}
  pageType="blog-post"
>
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <!-- SEO Meta Tags -->
  <Fragment slot="head">
    <!-- Open Graph -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    {featuredImageUrl && <meta property="og:image" content={featuredImageUrl} />}
    <meta property="article:published_time" content={initialPost.date} />
    {initialPost.modified && <meta property="article:modified_time" content={initialPost.modified} />}
    {initialPost.author?.node?.name && <meta property="article:author" content={initialPost.author.node.name} />}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    {featuredImageUrl && <meta name="twitter:image" content={featuredImageUrl} />}

    <!-- hreflang tags for multilingual -->
    <link rel="alternate" hreflang="es" href={`https://sauwasauna.com/es/guia-sauwa-sauna/${slug}/`} />
    <link rel="alternate" hreflang="ca" href={`https://sauwasauna.com/ca/guia-sauwa-sauna/${slug}/`} />
    <link rel="alternate" hreflang="en" href={`https://sauwasauna.com/en/guia-sauwa-sauna/${slug}/`} />
    <link rel="alternate" hreflang="fr" href={`https://sauwasauna.com/fr/guia-sauwa-sauna/${slug}/`} />
    <link rel="alternate" hreflang="x-default" href={`https://sauwasauna.com/es/guia-sauwa-sauna/${slug}/`} />
  </Fragment>

  <!-- Main Content -->
  <main class="blog-post-page"
        data-slug={slug}
        data-locale={locale}
        data-modified={initialPost.modified || initialPost.date}>

    <!-- Hero Section - Static Initial Content -->
    <BlogPostHero
      post={initialPost}
      locale={locale}
    />

    <!-- Content Section - Static Initial Content -->
    <BlogPostContent
      post={initialPost}
      locale={locale}
    />
  </main>

  <!-- Footer -->
  <FooterBlack locale={locale} />
</Layout>

<!-- Client-side content refresh (non-blocking) -->
<script>
  import { getPostBySlug } from '../../../lib/blog-queries';

  // Only refresh if page has been open for a while
  const REFRESH_DELAY = 3000; // 3 seconds after page load

  async function refreshContentIfNeeded() {
    const container = document.querySelector('.blog-post-page');
    if (!container) return;

    const slug = container.getAttribute('data-slug');
    const currentModified = container.getAttribute('data-modified');

    if (!slug) return;

    try {
      // Fetch latest content (will use 5min cache from blog-queries)
      const latestPost = await getPostBySlug(slug);

      if (!latestPost) return;

      // Check if content is newer
      const latestModified = latestPost.modified || latestPost.date;
      if (currentModified && new Date(latestModified) <= new Date(currentModified)) {
        return; // Content is up to date
      }

      // Update content if newer (optional - can be removed if not needed)
      // Since components are already rendered server-side, this is mainly for
      // ensuring very fresh content when users stay on page for long
      console.log('[Blog Refresh] Newer content available, but keeping static version for performance');

    } catch (error) {
      // Silently fail - static content is already displayed
      console.debug('[Blog Refresh] Could not refresh content:', error);
    }
  }

  // Optional: Refresh content after delay (can be removed for pure static)
  if (typeof window !== 'undefined') {
    setTimeout(refreshContentIfNeeded, REFRESH_DELAY);
  }
</script>

<style>
  .blog-post-page {
    min-height: 100vh;
    background: #ffffff;
  }

  /* Ensure no top padding on blog post pages (hero is full-screen) */
  :global(body:has(.blog-post-page)) {
    padding-top: 0;
  }
</style>