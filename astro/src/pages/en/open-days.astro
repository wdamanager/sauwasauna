---
/**
 * WDA-903: Page "Open Days" - EN
 * WDA-899: Frontend Booking - Free introductory event
 * WDA-907: Dynamic content from WordPress Session
 */

import Layout from '../../layouts/Layout.astro';
import NavbarScroll from '../../components/NavbarScroll.astro';
import FooterBlack from '../../components/layout/FooterBlack.astro';
import SessionHero from '../../components/booking/SessionHero.astro';
import BookingWidget from '../../components/booking/BookingWidget.astro';
import CollaboratorsSection from '../../components/booking/CollaboratorsSection.astro';
import { getBookingContent } from '../../lib/i18n/booking';
import { BOOKING_CONFIG } from '../../lib/booking/config';
import { fetchSessionServer } from '../../lib/booking/api';

const locale = 'en';
const content = getBookingContent(locale, 'puertasAbiertas');

const seoTitle = content.seoTitle;
const seoDescription = content.seoDescription;

// Fetch session from WordPress (SSG - for SEO fallback)
const sessionId = BOOKING_CONFIG.defaultSessionId; // 167
const session = await fetchSessionServer(sessionId);

// Get session details from WordPress or use defaults
const duration = session?.sessionDetails?.sessionDuration ?? 60;
const capacity = session?.sessionDetails?.sessionCapacity ?? 6;
const price = session?.sessionDetails?.sessionPrice ?? 0;

// Dynamic content from WordPress (will be hydrated client-side)
const sessionTitle = session?.title ?? content.hero.heading;
const sessionSubtitle = session?.sessionDetails?.subtitulo ?? content.hero.subtitle;

// Featured image from WordPress or fallback
const fallbackImage = '/images/sauwa-sauna-puertas-abiertas-hero.webp';
const backgroundImage = session?.featuredImage?.node?.sourceUrl ?? fallbackImage;

// Partner from WordPress (event location)
const partnerData = session?.sessionDetails?.partner?.edges?.[0]?.node;
const partner = partnerData ? {
  name: partnerData.title,
  slug: partnerData.slug,
  logo: partnerData.featuredImage?.node?.sourceUrl,
  url: partnerData.partnerInformation?.partnerWeb ?? undefined,
} : null;

// Sponsors (hardcoded for now - will come from API in future)
const sponsors = [
  {
    name: 'Aneto Natural',
    logo: '/images/sponsors/aneto-patrocinador-sauwa.jpg',
    url: 'https://www.caldoaneto.com/es',
  },
];
---

<Layout title={seoTitle} description={seoDescription} lang={locale} pageType="booking">
  <NavbarScroll locale={locale} />

  <main>
    <SessionHero
      title={content.hero.title}
      heading={sessionTitle}
      subtitle={sessionSubtitle}
      duration={duration}
      capacity={capacity}
      price={price}
      location={partner?.name}
      ctaText={content.hero.ctaText}
      ctaHref="#reserva"
      backgroundImage={backgroundImage}
      locale={locale}
      sessionId={sessionId}
    />

    <!-- About Section -->
    <section class="section section--bg-white" data-about-section>
      <div class="container container--narrow">
        <header class="section-header section-header--center">
          <h2 class="section-label section-label--primary">{content.about.title}</h2>
          <h3 class="section-title section-title--center">{content.about.heading}</h3>
        </header>

        <div class="about-content" data-hydrate="about-content">
          {content.about.description.map((paragraph) => (
            <p class="about-text">{paragraph}</p>
          ))}

          <ul class="highlights-list" data-hydrate="highlights-list">
            {content.about.highlights.map((item) => (
              <li class="highlights-item">
                <svg
                  class="highlights-icon"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <path
                    d="M5 13L9 17L19 7"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span>{item}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </section>

    <!-- Booking Section -->
    <section id="reserva" class="section section--bg-light booking-section">
      <div class="container">
        <header class="section-header section-header--center">
          <h2 class="section-label section-label--primary">{content.booking.sectionTitle}</h2>
          <h3 class="section-title section-title--center">{content.booking.sectionSubtitle}</h3>
        </header>

        <BookingWidget sessionId={sessionId} locale={locale} />
      </div>
    </section>

    <!-- Collaborators Section (Partner + Sponsors) -->
    <CollaboratorsSection
      partner={partner}
      sponsors={sponsors}
      locale={locale}
    />

    <!-- FAQ Section (hidden for now)
    <section class="section section--bg-white">
      <div class="container container--narrow">
        <header class="section-header section-header--center">
          <h2 class="section-label section-label--primary">{content.faq.title}</h2>
          <h3 class="section-title section-title--center">{content.faq.heading}</h3>
        </header>

        <div class="faq-list">
          {content.faq.items.map((item, index) => (
            <details class="faq-item" open={index === 0}>
              <summary class="faq-question">
                <span>{item.question}</span>
                <svg
                  class="faq-chevron"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M6 9L12 15L18 9"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </summary>
              <p class="faq-answer">{item.answer}</p>
            </details>
          ))}
        </div>
      </div>
    </section>
    -->
  </main>

  <FooterBlack locale={locale} />
</Layout>

<style>
  /* About Section - Using :global() for dynamically hydrated content */
  .about-content {
    max-width: 800px;
    margin: 0 auto;
  }

  :global(.about-content .about-text) {
    font-family: var(--font-family-secondary);
    font-weight: var(--font-weight-light);
    font-size: var(--font-scale-md);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-primary);
    margin-bottom: 1.5rem;
  }

  :global(.about-content .highlights-list) {
    list-style: none;
    padding: 0;
    margin: 2rem 0 0;
    display: grid;
    gap: 1rem;
  }

  :global(.about-content .highlights-item) {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    font-family: var(--font-family-secondary);
    font-size: var(--font-scale-base);
    color: var(--color-text-primary);
    line-height: 1.5;
  }

  :global(.about-content .highlights-icon) {
    flex-shrink: 0;
    color: #DB4529;
    margin-top: 2px;
  }

  /* Booking Section */
  .booking-section {
    padding-top: 4rem;
    padding-bottom: 4rem;
  }

  /* FAQ Section */
  .faq-list {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .faq-item {
    background: var(--color-bg-light);
    border-radius: 12px;
    overflow: hidden;
    transition: background 0.2s ease;
  }

  .faq-item[open] {
    background: white;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  }

  .faq-question {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    cursor: pointer;
    font-family: var(--font-family-secondary);
    font-weight: var(--font-weight-medium);
    font-size: var(--font-scale-md);
    color: var(--color-text-primary);
    list-style: none;
  }

  .faq-question::-webkit-details-marker {
    display: none;
  }

  .faq-question:hover {
    color: #DB4529;
  }

  .faq-chevron {
    flex-shrink: 0;
    transition: transform 0.2s ease;
    color: var(--color-text-secondary);
  }

  .faq-item[open] .faq-chevron {
    transform: rotate(180deg);
  }

  .faq-answer {
    padding: 0 1.5rem 1.25rem;
    font-family: var(--font-family-secondary);
    font-weight: var(--font-weight-light);
    font-size: var(--font-scale-base);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Responsive */
  @media (max-width: 767px) {
    :global(.about-content .about-text) {
      font-size: var(--font-scale-base);
    }

    .faq-question {
      font-size: var(--font-scale-base);
      padding: 1rem 1.25rem;
    }

    .faq-answer {
      padding: 0 1.25rem 1rem;
      font-size: var(--font-scale-sm);
    }

    .booking-section {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
  }
</style>

<script>
  /**
   * WDA-907: Client-side hydration for dynamic WordPress content
   * Fetches fresh session data and updates hero + about section without rebuild
   */
  import { getSession } from '../../lib/booking/api';

  /**
   * Parse WordPress content HTML and extract paragraphs and list items
   */
  function parseSessionContent(htmlContent: string): {
    paragraphs: string[];
    highlights: string[];
  } {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlContent, 'text/html');

    // Extract paragraphs (excluding empty ones)
    const paragraphs: string[] = [];
    doc.querySelectorAll('p').forEach((p) => {
      const text = p.textContent?.trim();
      if (text) paragraphs.push(text);
    });

    // Extract list items as highlights
    const highlights: string[] = [];
    doc.querySelectorAll('ul li, ol li').forEach((li) => {
      const text = li.textContent?.trim();
      if (text) highlights.push(text);
    });

    return { paragraphs, highlights };
  }

  /**
   * Create a highlight item with checkmark icon
   */
  function createHighlightItem(text: string): HTMLLIElement {
    const li = document.createElement('li');
    li.className = 'highlights-item';
    li.innerHTML = `
      <svg
        class="highlights-icon"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <path
          d="M5 13L9 17L19 7"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      <span>${text}</span>
    `;
    return li;
  }

  async function hydrateSessionContent() {
    const heroSection = document.querySelector('.session-hero');
    if (!heroSection) return;

    const sessionId = heroSection.getAttribute('data-session-id');
    if (!sessionId) return;

    try {
      const session = await getSession(parseInt(sessionId, 10));
      if (!session) return;

      // ===== HERO SECTION =====

      // Update hero heading (title)
      const headingEl = heroSection.querySelector('[data-hydrate="heading"]');
      if (headingEl && session.title) {
        headingEl.textContent = session.title;
      }

      // Update hero subtitle
      const subtitleEl = heroSection.querySelector('[data-hydrate="subtitle"]');
      if (subtitleEl && session.sessionDetails?.subtitulo) {
        subtitleEl.textContent = session.sessionDetails.subtitulo;
      }

      // Update hero background image
      const backgroundEl = heroSection.querySelector('[data-hydrate="background"]');
      if (backgroundEl && session.featuredImage?.node?.sourceUrl) {
        (backgroundEl as HTMLElement).style.backgroundImage =
          `url('${session.featuredImage.node.sourceUrl}')`;
      }

      // ===== ABOUT SECTION =====

      if (session.content) {
        const { paragraphs, highlights } = parseSessionContent(session.content);

        // Update paragraphs in about section
        const aboutContentEl = document.querySelector('[data-hydrate="about-content"]');
        if (aboutContentEl && paragraphs.length > 0) {
          // Remove existing paragraphs (keep the highlights list)
          const existingParagraphs = aboutContentEl.querySelectorAll('.about-text');
          existingParagraphs.forEach((p) => p.remove());

          // Insert new paragraphs before the highlights list
          const highlightsList = aboutContentEl.querySelector('[data-hydrate="highlights-list"]');
          paragraphs.forEach((text) => {
            const p = document.createElement('p');
            p.className = 'about-text';
            p.textContent = text;
            if (highlightsList) {
              aboutContentEl.insertBefore(p, highlightsList);
            } else {
              aboutContentEl.appendChild(p);
            }
          });
        }

        // Update highlights list
        const highlightsListEl = document.querySelector('[data-hydrate="highlights-list"]');
        if (highlightsListEl && highlights.length > 0) {
          highlightsListEl.innerHTML = '';
          highlights.forEach((text) => {
            highlightsListEl.appendChild(createHighlightItem(text));
          });
        }
      }

      console.log('[WDA-907] Session content hydrated from WordPress');
    } catch (error) {
      console.warn('[WDA-907] Could not hydrate session content:', error);
      // SSG fallback content remains visible
    }
  }

  // Run hydration when DOM is ready
  document.addEventListener('DOMContentLoaded', hydrateSessionContent);
</script>
