---
/**
 * WDA-998: Session Card Component
 * Displays session info adapted by type:
 * - single: duration, price (per person implicit)
 * - pack: duration, included persons, price
 * - voucher: number of sessions, validity, price
 * - private: duration, "exclusive use", price
 */
import type { SessionData, SessionType } from '../../lib/sessions-queries';
import { getCardContent, type Locale } from '../../lib/i18n/sessionTypes';
import { getLocalizedValue } from '../../lib/i18n/fallback';

interface Props {
  session: SessionData;
  type: SessionType;
  locale: Locale;
  partnerSlug: string;
}

const { session, type, locale, partnerSlug } = Astro.props;

const cardContent = getCardContent(locale);

// Build session URL
const sessionSlug = session.translations.find(t => t.locale === locale)?.slug || session.slug;
const sessionUrl = `/${locale}/${partnerSlug}/${sessionSlug}/`;

// Localized title with fallback to Spanish
const localizedTitle = getLocalizedValue(
  {
    es: session.title,
    ca: session.localizedTitle?.ca,
    en: session.localizedTitle?.en,
    fr: session.localizedTitle?.fr,
  },
  locale
);

// Localized subtitle
const subtitle = getLocalizedValue(
  {
    es: session.subtitle?.es,
    ca: session.subtitle?.ca,
    en: session.subtitle?.en,
    fr: session.subtitle?.fr,
  },
  locale
);

// What to show based on type
const showDuration = type !== 'voucher';
const showPeople = type === 'pack';
const showSessions = type === 'voucher';
const showValidity = type === 'voucher';
const showExclusive = type === 'private';

// Format people/sessions count
const peopleCount = session.includedPersons || 2;
const peopleLabel = peopleCount === 1 ? cardContent.person : cardContent.people;
const sessionsLabel = peopleCount === 1 ? cardContent.session : cardContent.sessions;

// Validity (for vouchers) - default 12 months if not specified
const validityMonths = session.voucherValidityMonths || 12;
const monthsLabel = validityMonths === 1 ? cardContent.month : cardContent.months;
---

<article class={`session-card session-card--${type}`}>
  <a href={sessionUrl} class="session-card__link">
    {session.featuredImage && (
      <div class="session-card__image">
        <img
          src={session.featuredImage.sourceUrl}
          alt={session.featuredImage.altText || localizedTitle}
          loading="lazy"
          width="400"
          height="240"
        />
      </div>
    )}
    <div class="session-card__content">
      <h4 class="session-card__title">{localizedTitle}</h4>
      {subtitle && <p class="session-card__subtitle">{subtitle}</p>}

      <div class="session-card__meta">
        {showDuration && (
          <span class="session-card__meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            {session.duration} min
          </span>
        )}

        {showPeople && (
          <span class="session-card__meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            {peopleCount} {peopleLabel}
          </span>
        )}

        {showSessions && (
          <span class="session-card__meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {peopleCount} {sessionsLabel}
          </span>
        )}

        {showValidity && (
          <span class="session-card__meta-item">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            {cardContent.validFor} {validityMonths} {monthsLabel}
          </span>
        )}

        {showExclusive && (
          <span class="session-card__meta-item session-card__meta-item--exclusive">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            {cardContent.exclusive}
          </span>
        )}

        <span class="session-card__price">
          {session.price}â‚¬
        </span>
      </div>
    </div>
  </a>
</article>

<style>
  .session-card {
    background: #ffffff;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 400ms ease-out;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .session-card:hover {
    transform: scale(1.03);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
  }

  .session-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  .session-card__link:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 2px;
  }

  .session-card__image {
    width: 100%;
    height: 200px;
    overflow: hidden;
    background: #f5f5f5;
    position: relative;
  }

  .session-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 400ms ease-out;
  }

  .session-card:hover .session-card__image img {
    transform: scale(1.1);
  }

  .session-card__content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex-grow: 1;
  }

  .session-card__title {
    font-family: var(--font-family-secondary);
    font-size: 1.125rem;
    font-weight: var(--font-weight-medium);
    line-height: 1.4;
    color: var(--color-text-primary);
    margin: 0;
    transition: color 0.2s;
  }

  .session-card:hover .session-card__title {
    color: var(--color-primary);
  }

  .session-card__subtitle {
    font-family: var(--font-family-primary);
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .session-card__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: auto;
    padding-top: 0.75rem;
    border-top: 1px solid #f0f0f0;
    align-items: center;
  }

  .session-card__meta-item {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-family: var(--font-family-primary);
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
  }

  .session-card__meta-item svg {
    flex-shrink: 0;
    color: var(--color-primary);
  }

  .session-card__meta-item--exclusive {
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
  }

  .session-card__price {
    margin-left: auto;
    font-family: var(--font-family-primary);
    font-weight: var(--font-weight-semibold);
    font-size: 1.125rem;
    color: var(--color-primary);
  }

  /* Type-specific styling */
  .session-card--voucher .session-card__image {
    height: 160px;
  }
</style>
