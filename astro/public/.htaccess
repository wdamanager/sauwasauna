# SAUWA - Apache Configuration
# Generated by Astro build process
# WDA-990: Enhanced with Dynamic Content Catch-All

<IfModule mod_rewrite.c>
    RewriteEngine On

    # ============================================
    # LANGUAGE DETECTION & REDIRECT (Fix: No more "Redirecting..." text)
    # ============================================

    # Redirect root (/) to language-specific homepage
    # Priority order: Accept-Language header â†’ Default (ES)

    RewriteCond %{REQUEST_URI} ^/$
    RewriteCond %{HTTP:Accept-Language} ^ca [NC]
    RewriteRule ^$ /ca/ [R=302,L]

    RewriteCond %{REQUEST_URI} ^/$
    RewriteCond %{HTTP:Accept-Language} ^en [NC]
    RewriteRule ^$ /en/ [R=302,L]

    RewriteCond %{REQUEST_URI} ^/$
    RewriteCond %{HTTP:Accept-Language} ^fr [NC]
    RewriteRule ^$ /fr/ [R=302,L]

    # Default: Redirect to Spanish (if no match or ES browser)
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^$ /es/ [R=302,L]

    # ============================================
    # SITEMAP PROXY TO WORDPRESS BACKEND (WDA-555)
    # ============================================

    # Proxy sitemap.xml to WordPress backend
    # Option 1: Direct proxy (requires mod_proxy)
    # RewriteRule ^sitemap\.xml$ https://backend.sauwasauna.com/sitemap.xml [P,L]

    # Option 2: PHP proxy (more compatible with shared hosting)
    RewriteRule ^sitemap\.xml$ sitemap-proxy.php [L]

    # ============================================
    # WDA-990: DYNAMIC CONTENT CATCH-ALL
    # ============================================
    # When partner/session URLs don't exist as static pages
    # (created in WordPress after Astro build), redirect to
    # dynamic loader pages that fetch content from API at runtime.

    # EXCLUDE known static routes from catch-all
    # Blog/Guide pages
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/guia-sauwa-sauna(/|$) [NC]
    RewriteRule ^ - [L]

    # Legal pages
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(politica-de-privacidad|privacy-policy|politique-de-confidentialite|politica-de-privacitat)(/|$) [NC]
    RewriteRule ^ - [L]

    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(aviso-legal|legal-notice|mentions-legales|avis-legal)(/|$) [NC]
    RewriteRule ^ - [L]

    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(politica-de-cookies|cookie-policy|politique-cookies)(/|$) [NC]
    RewriteRule ^ - [L]

    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(condiciones-contratacion|booking-terms|conditions-reservation|condicions-contractacio)(/|$) [NC]
    RewriteRule ^ - [L]

    # Work with us pages
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(trabaja-con-nosotros|work-with-us|travailler-avec-nous|treballa-amb-nosaltres)(/|$) [NC]
    RewriteRule ^ - [L]

    # Hotel partners landing pages
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(partners-hoteleros|hotel-partners|partenaires-hoteliers|socis-hotelers)(/|$) [NC]
    RewriteRule ^ - [L]

    # Open days pages
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/(puertas-abiertas|open-days|portes-ouvertes|portes-obertes)(/|$) [NC]
    RewriteRule ^ - [L]

    # Dynamic pages themselves (don't rewrite the handlers)
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/dynamic(/|$) [NC]
    RewriteRule ^ - [L]

    # SESSION CATCH-ALL (3-segment URLs: /locale/partner/session/)
    # Pattern: /es/hotel-name/session-name/ -> /es/dynamic/session.html?slug=session-name&partner=hotel-name
    # Must come BEFORE partner catch-all (more specific rule first)
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/([^/]+)/([^/]+)/?$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{DOCUMENT_ROOT}/$1/$2/$3/index.html !-f
    RewriteRule ^(es|ca|en|fr)/([^/]+)/([^/]+)/?$ /$1/dynamic/session.html?slug=$3&partner=$2 [L,QSA]

    # PARTNER CATCH-ALL (2-segment URLs: /locale/partner/)
    # Pattern: /es/hotel-name/ -> /es/dynamic/partner.html?slug=hotel-name
    RewriteCond %{REQUEST_URI} ^/(es|ca|en|fr)/([^/]+)/?$
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{DOCUMENT_ROOT}/$1/$2/index.html !-f
    RewriteRule ^(es|ca|en|fr)/([^/]+)/?$ /$1/dynamic/partner.html?slug=$2 [L,QSA]
</IfModule>

# ============================================
# ERROR DOCUMENT
# ============================================

ErrorDocument 404 /404.html

# ============================================
# SECURITY HEADERS
# ============================================

<IfModule mod_headers.c>
    # X-Content-Type-Options
    Header set X-Content-Type-Options "nosniff"

    # X-Frame-Options
    Header set X-Frame-Options "SAMEORIGIN"

    # Referrer-Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"

    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
</IfModule>

# ============================================
# CACHE CONTROL
# ============================================

<IfModule mod_expires.c>
    ExpiresActive On

    # HTML (short cache for dynamic content support)
    ExpiresByType text/html "access plus 1 hour"

    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"

    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"

    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
</IfModule>

# ============================================
# COMPRESSION
# ============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>
